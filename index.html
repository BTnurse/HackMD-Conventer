<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>HackMD Converter</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script> <!-- ZIP å‡½å¼åº« -->
<style>
body { font-family: Arial, sans-serif; padding: 30px; background: #f3f3f3; }
h1, h2, h3 { color: #333; text-align:center; }
input { width: 60%; padding: 8px; }
button { padding: 8px 12px; margin-left: 10px; }
textarea { width: 100%; height: 300px; margin-top: 20px; }
.upload-box { margin-top:20px; padding:15px; background:#fff; border-radius:8px; }
</style>
</head>
<body>

<h1>HackMD ç­†è¨˜æ¬é‹å·¥å…·</h1>
<h2>ğŸ§  <font color=blue>è¼¸å…¥ HackMD ç­†è¨˜ç¶²å€</font>ï¼Œæˆ– <font color=blue>ä¸Šå‚³æ•™ææª”æ¡ˆ</font>è‡ªå‹•è§£æ</h2>
<center><font color=red size="5"> â€¼ï¸ ç¶²é è£½ä½œç´”å±¬å­¸ç¿’åˆ†äº«ï¼Œä½¿ç”¨è³‡æ–™è«‹å°Šé‡åŸä½œè€…æ™ºæ…§è²¡ç”¢æ¬Šâ€¼ï¸</font></center>
<hr>

<!-- HackMD URL -->
<font size=4>ğŸŒŸ å–®ç¯‡ç­†è¨˜ï¼Œ<font color=blue>è«‹è¼¸å…¥é è½‰æ›çš„ HackMD ç­†è¨˜ç¶²å€ï¼š</font></font><br>
<input type="text" id="urlInput" placeholder="è¼¸å…¥ HackMD ç¶²å€... ä¾‹å¦‚ https://hackmd.io/@user/note">
<button onclick="downloadNote()">ä¸‹è¼‰ Markdown</button>
<p><font color=red size="4">ğŸ’¡ ç¶²å€è¼¸å…¥å°æŠ€å·§ï¼š</font><br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ‘‰ è¼¸å…¥ https://hackmd.io/@ä½œè€…å¸³è™Ÿ â¡ï¸ è‡ªå‹•ä¸‹è¼‰ç­†è¨˜ä½œè€…ç‚ºã€Œä½œè€…å¸³è™Ÿã€çš„å…¨éƒ¨ç­†è¨˜ï¼ˆåƒ…é™å·²å…¬é–‹çš„ç­†è¨˜ï¼‰<font color="#E0E0E0" size=2>ï¼ˆe.g. https://hackmd.io/@johnsonnoteï¼‰</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ‘‰ è¼¸å…¥ https://hackmd.io/@ä½œè€…å¸³è™Ÿ/æ–‡ç« æ¨™é¡Œ â¡ï¸ ä¸‹è¼‰å–®ç¯‡ç­†è¨˜<font color="#E0E0E0" size=2>ï¼ˆe.g. https://hackmd.io/@johnsonnote/ai_llmï¼‰</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ‘‰ è¼¸å…¥ https://hackmd.io/@ä½œè€…å¸³è™Ÿ/collection/xxx â¡ï¸ ä¸‹è¼‰åˆé›†å…§å…¨éƒ¨ç­†è¨˜ï¼ˆåƒ…é™å·²å…¬é–‹çš„ç­†è¨˜ï¼‰<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ‘‰ è¼¸å…¥ https://hackmd.io/@jä½œè€…å¸³è™Ÿ?view=all â¡ï¸ ä¸‹è¼‰ä½œè€…å¸³è™Ÿé é¢å…§å…¨éƒ¨ç­†è¨˜ï¼ˆåƒ…é™å·²å…¬é–‹çš„ç­†è¨˜ï¼‰<br>

<hr>

<!-- ä¸Šå‚³æœ¬åœ°æª”æ¡ˆ -->
<font size=4>æˆ–  ä¸‹è¼‰å¤šç¯‡</font><br>
<font color=blue size=4>ğŸ“ è«‹ä¸Šå‚³æ•™æï¼ˆ.html / .mdï¼‰ï¼š</font><br>
<div class="upload-box">
    <input type="file" id="fileInput" accept=".html,.htm,.md,.txt">
    <button onclick="processFile()">è§£ææ•™æ â†’ ä¸‹è¼‰æ‰€æœ‰ç­†è¨˜</button>
</div>

<!-- æ–°å¢é€²åº¦æ¢ï¼Œæ”¾åœ¨é¡¯ç¤º Markdown ä¸Šæ–¹ -->
<div id="progressDiv"></div>

<hr>

<!-- é¡¯ç¤ºæŠ“åˆ°çš„ Markdown å…§å®¹ -->
<font color=blue size=4>ğŸ“‹ é¡¯ç¤º Markdown</font><br>
<textarea id="output" placeholder="ç­†è¨˜å…§å®¹ Markdown èªæ³•æœƒé¡¯ç¤ºåœ¨é€™è£¡"></textarea>

<script>

function sanitizeName(name) {
    // åªä¿ç•™è‹±æ•¸ã€åº•ç·šã€æ¸›è™Ÿï¼Œä¸å…è¨±å…¶ä»–ç‰¹æ®Šç¬¦è™Ÿ
    return name.replace(/[^a-zA-Z0-9_-]/g, "_");
}

/* ======================================================
   ä¸‹è¼‰å–®ç¯‡ HackMDï¼ˆskipDownload æ™‚ä¸å¦å­˜ï¼‰
====================================================== */
async function downloadNote(urlOverride=null, skipDownload=false) {
    const url = urlOverride || document.getElementById('urlInput').value.trim();
    if(!url) { alert("è«‹è¼¸å…¥ HackMD ç¶²å€"); return; }

    const output = document.getElementById('output');
    if (!skipDownload) output.value = "æ­£åœ¨ä¸‹è¼‰ç­†è¨˜...\n";

    try {
        let notePath = new URL(url).pathname.replace(/^\/+/,'');

        let downloadUrl = `https://hackmd.io/${notePath}/download`;
        const response = await fetch(downloadUrl);

        if(!response.ok) {
            if (!skipDownload) throw new Error(`HTTP ${response.status}`);
            return null;
        }

        const mdText = await response.text();

        if (!skipDownload) output.value = mdText;

        // ====== å»ºç«‹å®‰å…¨æª”å ======
        let parts = notePath.split("/"); // 0=ä½œè€…ï¼Œ1=æ–‡ç« åç¨±
        let author = sanitizeName(parts[0] || "unknown");
        let notePart = sanitizeName(parts[1] || "note");

        // æª”ååªç”¨ä½œè€…åç¨±å¾Œçš„å­—å…ƒ (ç¬¬äºŒæ®µ)
        let safeFilename = `${notePart}.md`;

        // å–®æª”æ¨¡å¼è¦ç«‹å³ä¸‹è¼‰
        if (!skipDownload) {
            const blob = new Blob([mdText], {type: "text/markdown;charset=utf-8"});
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = safeFilename;
            link.click();
        }

        return {
            filename: safeFilename,
            content: mdText,
            noteName: notePart
        };

    } catch (err) {
        if (!skipDownload) {
            alert("ä¸‹è¼‰å¤±æ•—ï¼š" + err);
            output.value = "";
        }
        return null;
    }
}

/* ======================================================
   æ•™ææŠ“é€£çµ â†’ ZIPï¼ˆä¾å‰å…©æ®µåˆ†é¡è³‡æ–™å¤¾ï¼‰
====================================================== */
function processFile() {
    const fileInput = document.getElementById("fileInput");
    if (!fileInput.files.length) {
        alert("è«‹é¸æ“‡æ•™ææª”æ¡ˆï¼");
        return;
    }

    const file = fileInput.files[0];
    const reader = new FileReader();

    reader.onload = async function(e) {
        const text = e.target.result;

        const regex = /https?:\/\/hackmd\.io\/[^\s)'"<>]+/g;
        const links = text.match(regex) || [];

        if (links.length === 0) {
            alert("æœªåœ¨æ•™æä¸­æ‰¾åˆ°ä»»ä½• HackMD ç­†è¨˜é€£çµï¼");
            return;
        }

        alert(`æ‰¾åˆ° ${links.length} å€‹ HackMD é€£çµï¼Œé–‹å§‹ä¸‹è¼‰...`);

        // å»ºç«‹é€²åº¦æ¢å…ƒç´ ï¼ˆæ”¾åœ¨ output ä¸Šæ–¹ï¼‰
        let output = document.getElementById("output");
        let progressDiv = document.getElementById("progressDiv");
        if (!progressDiv) {
            progressDiv = document.createElement("div");
            progressDiv.id = "progressDiv";
            progressDiv.style = "margin-bottom:10px; font-weight:bold; color:#333;";
            output.parentNode.insertBefore(progressDiv, output);
        }
        progressDiv.innerText = "æº–å‚™ä¸‹è¼‰...";

        let zip = new JSZip();

        for (let i = 0; i < links.length; i++) {
            progressDiv.innerText = `ä¸‹è¼‰ä¸­ (${i+1}/${links.length}): ${links[i]}`;

            const result = await downloadNote(links[i], true);
            if (result) {
                // å‰å…©æ®µåˆ†é¡è³‡æ–™å¤¾ï¼ˆæ”¹ç”¨ noteName çš„å‰å…©æ®µå­—å…ƒï¼‰
                let nameParts = result.noteName.split("_");
                let folderName = "others";

                if (nameParts.length >= 2) {
                    folderName = sanitizeName(nameParts[0] + "_" + nameParts[1]);
                }

                if (!zip.folder(folderName)) zip.folder(folderName);

                zip.folder(folderName).file(result.filename, result.content);
            }

            await new Promise(r => setTimeout(r, 200));
        }

        progressDiv.innerText = "æ­£åœ¨ç”¢ç”Ÿ ZIP æª”æ¡ˆï¼Œè«‹ç¨å€™...";

        const finalZip = await zip.generateAsync({
            type: "blob",
            compression: "DEFLATE",
            compressionOptions: { level: 6 }
        });

        const link = document.createElement("a");
        link.href = URL.createObjectURL(finalZip);
        link.download = "HackMD_All_Files.zip";
        link.click();

        progressDiv.innerText = "ä¸‹è¼‰å®Œæˆï¼ŒZIP å·²åŒ¯å‡ºï¼è«‹ä»¥7-Zipè§£å£“ç¸®ã€‚";
    };

    reader.readAsText(file, "utf-8");
}

</script>
</body>
</html>
